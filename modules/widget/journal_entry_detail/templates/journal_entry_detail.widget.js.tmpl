Widget.types['journal_entry_detail'] = {
	initialize: function() {
		this._element = jQuery.parseHTML('{{includeTemplate=edit}}');
		this._element.accordion({active: 0, autoHeight: false, clearStyle: true});
		
		this.text_widget = this._element.find('.text-widget').attr('data-widget-session', this.settings.richtext_session);
		this.text_widget.prepareWidget(function(text_widget) {
			this.handle('saving', function(event, data) {
				data.text = text_widget.get_data();
			});
		}.bind(this));	
			
		Widget.create('detail', function(widget) {
			widget.set_instance(this);
			jQuery.extend(widget.settings, {
				title: "{{writeString=wns.journal_entry.create}}",
				width: 800
			});
			if(this.auto_open) {
				this.open();
			}
		}.bind(this));
	},
	
	open: function() {
		if(!this.detail_widget) {
			this.auto_open = true;
			return false;
		}
		this.detail_widget.open();
	},

	fill_data: function() {
		this.loadData(function(data) {
			var comment_list = this._element.find('ol.comments').empty();
			var title = this._element.find('input[name="title"]');
			if(data) {
				this.detail_widget.set_title(data.Title);
				this.set_text(data.Text);
				title.val(data.Title);
				jQuery.each(data.comments, function(i, comment) {
					var comm = jQuery('<li/>');
					comm.text(comment.CreatedAtFormatted+' '+comment.Email);
					var txt = jQuery('<div/>');
					txt.html(comment.Text);
					comm.append(txt.hide());
					comm.click(txt.toggle.bind(txt));
					comment_list.append(comm);
				});
			}
		});
	},

	set_text: function(text) {
		this.text_widget.ensureWidget(function(widget) {
			console.log('ensureWidget', widget);
			widget.set_data(text);
		}.bind(this));
	},
	
	close: function() {
		this.detail_widget.close();
		this.close_callback();
	}
};
